name: Build SHA Image

on:
  workflow_dispatch:
    inputs:
      sha:
        description: 'Git SHA to build (full or short)'
        required: true
        type: string
      tag:
        description: 'Additional Docker tag (e.g. pre-renovation). Leave empty to only tag with SHA.'
        required: false
        type: string
      run_tests:
        description: 'Run unit tests before building'
        required: false
        type: boolean
        default: false

concurrency:
  group: build-sha-${{ inputs.sha }}
  cancel-in-progress: false

jobs:
  build-and-push:
    name: Build All-in-One Image at SHA
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout target SHA
        run: git checkout ${{ inputs.sha }}

      - name: Resolve SHA
        id: resolve
        run: |
          echo "full_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Overlay Dockerfile.allinone and docker/ from main
        run: |
          git fetch origin main
          git checkout origin/main -- Dockerfile.allinone docker/

      - name: Install uv
        if: ${{ inputs.run_tests }}
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Run backend unit tests
        if: ${{ inputs.run_tests }}
        run: |
          uv sync --extra test
          uv run pytest backend/tests/unit -v

      - name: Run frontend lint + tests
        if: ${{ inputs.run_tests }}
        run: |
          cd frontend && npm ci
          npm run lint
          npm test -- --run

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute tags
        id: tags
        env:
          USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          SHORT_SHA: ${{ steps.resolve.outputs.short_sha }}
          CUSTOM_TAG: ${{ inputs.tag }}
        run: |
          TAGS="${USERNAME}/banana-slides:sha-${SHORT_SHA}"
          if [ -n "$CUSTOM_TAG" ]; then
            TAGS="${TAGS},${USERNAME}/banana-slides:${CUSTOM_TAG}"
          fi
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Built tags: $TAGS"

      - name: Build and push all-in-one image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.allinone
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/banana-slides:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/banana-slides:buildcache,mode=max
          build-args: |
            DOCKER_REGISTRY=${{ secrets.DOCKER_REGISTRY }}
            GHCR_REGISTRY=${{ secrets.GHCR_REGISTRY || 'ghcr.io/' }}
            APT_MIRROR=${{ secrets.APT_MIRROR }}
            PYPI_INDEX_URL=${{ secrets.PYPI_INDEX_URL }}
            NPM_REGISTRY=${{ secrets.NPM_REGISTRY }}
